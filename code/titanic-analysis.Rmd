---
title: 'Pràctica 2: Neteja i anàlisi de les dades'
author: 'Adrián Alonso Gonzalo i Alexandre Vidal De Palol'
date: "Maig/Juny 2022"
output:
  pdf_document:
    latex_engine: xelatex
    highlight: zenburn
    toc: yes
    number_sections: true
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 3
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval=T, echo=T)
```

# Càrrega de llibreries.

En aquesta secció, carregarem les llibreries que s'utilitzaran durant la realització d'aquesta pràctica.

```{r message= FALSE, warning=FALSE}

library(mice)
library(ggplot2)
library(magrittr)
library(dplyr)

```

# Descripció i càrrega del dataset.

Els conjunts de dades train.csv i 'test.csv' que es troben a la carpeta 'data/input' d'aquest paquet s'han obtingut del web https://www.kaggle.com/c/titanic.

Aquests conjunts de dades contenen informació sobre la tripulació del Titanic amb 12 (11 el de test) columnes i un total de 891 registres (418 el de test).

Les variables d’aquesta mostra son:

- PassengerId: Número de passatger.
- Survived: Supervivència (0=No, 1=Si).
- Pclass: Classe de tiquet (1=Primera, 2=Segona, 3=Tercera) .
- Name: Nom.
- Sex: Sexe.
- Age: Edat.
- SibSp: Germans / Cónjugues a bord del Titanic.
- Parch: Pares / nens a bord del Titanic.
- Ticket: Número de ticket.
- Fare: Preu del ticket.
- Cabin: Numero de cabina.
- Embarked: Port de embarcament.

A continuació, passem a carregar el fitxer i a mostrar una sèrie de metadades del conjunt que ens donaran una primer idea del joc de dades amb el que estem tractant.

```{r message= FALSE, warning=FALSE}

# Carreguem els fitxers 'test.csv' i 'train.csv' de la carpeta 'data/input' (indicant que volem els 'strings' com 'factors')
test_dataset <- read.csv("../data/input/test.csv", stringsAsFactors=TRUE)
train_dataset <- read.csv("../data/input/train.csv", stringsAsFactors=TRUE)

# Mostrem les primeres files dels jocs de dades
head(test_dataset)
head(train_dataset)

# Creem una nova columna amb el nom del dataset del qual provenen les files
test_dataset['row_type'] <- as.factor('test')
train_dataset['row_type'] <- as.factor('train')

# Creem la columna 'Survived' ja que el joc de dades de test no la conté (introduïrem un valor dummy que després eliminarem)
test_dataset['Survived'] <- 99

# Juntem els dos jocs de dades en un únic dataset per poder netejar els dos a la vegada
dataset <- rbind(train_dataset, test_dataset[,colnames(train_dataset)])

# Mostrem les primeres files del dataset unificat
head(dataset)

# Mostrem l'estructura del dataset
str(dataset)

# Mostrem un resum de les estadistiques de les columnes del dataset
summary(dataset)

# Mostrem el número de files del joc de dades unificat i per separat
dim(dataset)[1]
dim(dataset[dataset$row_type=='test',])[1]
dim(dataset[dataset$row_type=='train',])[1]

```

Observem que que el dataset conté 3 tipus de variables del quals caràcter, numèric i enter.

# Integració i selecció de les dades d’interès a analitzar.


El procés d'integració i selecció de les dades es realitzarà al llarg del procés de neteja
i anàlisi de les diverses variables del conjunt de dades d'entrenament del dataset (on la columna 'row_type' és igual a 'train').

En aquest procés es pretén anar analitzant les diferents variables en el procés de neteja i anàlisi, i en
funció de les característiques que es vagin observant de les diverses variables es prendrà la decisió d'utilitzar un conjunt seleccionat el qual pugui ser útil per a la predicció del model i la comprovació amb el conjunt de test o validació.

El resultat del projecte pot respondre a possibles causes de mort dels tripulants que no van sobreviure a la tragèdia del Titanic, permetent
establir models d'inferència sobre les causes relatives a la mortalitat entre diversos tipus de passatgers.
Per altra banda la implementació de un model d'interès sobre quines han sigut variables que han influït més o menys en la supervivència del naufragi.

```{r message= FALSE, warning=FALSE}

# Mostrem un subconjunt de dades 
head(dataset)

```


# Neteja de dades.

## Valors buits (missing values).

En aquesta secció, farem un petit anàlisi sobre l'existència de valors buits o valors no informats en el nostre joc de dades. A partir de l'identificació de columnes amb valors buits, aplicarem diverses tècniques per inputar valors en els registres que contenen columnes amb aquestes característiques.

### Identificació de les columnes amb valors buits.

En aquesta secció identificarem les columnes que contenen aquest tipus de valors.

```{r message= FALSE, warning=FALSE}

# Mostrem el número de registres buits per cada columna 
apply(dataset=="",2, sum)
apply(is.na(dataset),2, sum)

```

En els resultats anteriors podem observar que les variables amb valors buits són **Age**, **Cabin** i **Embarked**.

### Ajust de la variable 'Age'.

En aquesta secció tractem la columna 'Age' amb l'objectiu de inputar nous valors que en aquells registres on el seu valor és buit o no informat.

```{r message= FALSE, warning=FALSE}

# Transformem la variable 'dataset' a data.frame.
dataset <- as.data.frame(dataset)

# Inputem els valors d'edat que falten amb l'ajuda del paquet MICE
input <- mice(
  dataset[, !names(dataset) %in%
            c('PassengerId','Name','Ticket','Cabin','Survived'
              ,'Assigned','FL','FT','ticketlength','one','two'
              ,'three','four','five','six','seven')], rfPackage = "randomForest")
trained_mouse <- complete(input)

```

A continuació, crearem dos histogrames amb la finalitat de comprovar que els valors generats per el paquet 'mice' no degraden la qualitat del nostre joc de dades.

```{r pplot, echo = FALSE, warning = FALSE}

# Creem histogramas per observar si els valors imputats a la variable 'Age' mostren gaire diferència
ggplot(dataset, aes(x=Age))+geom_density(adjust=.5)+labs(title="Original Data")
ggplot(trained_mouse, aes(x=Age))+geom_density(adjust=.5)+labs(title="Inputed Data")

```

Observem que els dos gràfics són raonablement semblants, per tant procedim a reemplaçar les dades dels valors inputats als originals.

```{r message= FALSE, warning=FALSE}

# Insertem a la columna 'Age' del dataset original la nova columna calculada amb la lliberia 'mice'
dataset$Age <- trained_mouse$Age

```

### Ajust de la variable 'Embarked'.

Com hem vist anteriorment, hi ha dos valors de la variable **Embarked** que falten. Per trobar el valor d'aquestes dues observacions, procedim a verificar-ho amb l'ajuda dels valors de la variable **Cabin**.

A partir de les dades, podem comprobar que totes les cabines que comencen amb **B** es van embarcar des de les ciutats de Southampton o Charbourg.

```{r message= FALSE, warning=FALSE}

# Mostrem els valors únics de la variable 'Embark' quan el nom de la cabina comença per 'B'
unique(dataset[grep("*^B", dataset$Cabin),]$Embarked)

```
A més a més, podem veure que els bitllets de viatge de tipus **B** costen al voltant de 80 USD, que és molt similar a la tarifa mitja o mitjana dels passatgers **S**.

```{r message= FALSE, warning=FALSE}

# Calcul de la mitja i la mitjana de les cabines que comencen per 'B' (agrupat pels valors de la variable 'Embark')
dataset[grep("*^B", dataset$Cabin),] %>% group_by(Embarked) %>% summarize_each(funs(mean),Fare)
dataset[grep("*^B", dataset$Cabin),] %>% group_by(Embarked) %>% summarize_each(funs(median),Fare)

```

Per tant, procedim a inputar els dos valors perduts de **Embarked** com a tipus **S**.

```{r message= FALSE, warning=FALSE}

# Inputem el valor 'S' en les dues observacions amb valors buits
dataset$Embarked[c(62, 830)] <- 'S'

```

### Ajust de la variable 'Fare'.

En aquest cas, com només es tracta d'un registre que no conté la dada, el que farem serà introduïr la mitjana de la resta de valors d'aquesta columna. Aquesta tècnica d'inputació de dades és molt freqüent quan la quantitat de valors no informats és petita i quan l'atribut és del tipus numèric. 

Primer de tot, busquem on està localitzat el valor perdut de la variable **Fare**.

```{r message= FALSE, warning=FALSE}

# Trobem quina és la posició de l'observació que conté el valor buit/NULL
which(is.na(dataset$Fare))

```

A continuació, trobem la mitjana del total dels tiquets excloent el valor perdut.

```{r message= FALSE, warning=FALSE}

# Calculem la mitjana dels valors de la columna 'Fare' eliminant el registre amb valor buit
mean_fare <- mean(dataset$Fare, na.rm = TRUE)

```

Per últim, inputem el el valor obtingut al valor perdut de la columna **Fare**.

```{r message= FALSE, warning=FALSE}

# Definim el valor de l'observació número '1044' amb el valor de la mitjana abans calculat
dataset$Fare[c(1044)] <- mean_fare

```

### Comprovació de valors buits.

Com podem observar en el càlcul que computarem a continuació, la quantitat de valors no informats després del tractament és de zero observacions.

```{r message= FALSE, warning=FALSE}

# Mostrem el número de registres buits per cada columna 
apply(dataset=="",2, sum)
apply(is.na(dataset),2, sum)

```


## Valors extrems (outliers).

L'estudi de valors extrem el farem només en les variables del tipus quantitatiu. Això és així ja que, per les variables del tipus qualitatiu, és molt difícil saber que vol dir que un valor esta fora del que es considera 'normal' (o similar a la resta).

### Identificació de les columnes amb valors extrems

A continuació, passem a mostrar una sèrie de gràfiques i taules d'estadístiques que ens ajudaran a identificar aquells atributs amb valors extrems.

```{r message= FALSE, warning=FALSE}

# Mostrem l'histograma i un resum de la variable 'Survived'
hist(dataset$Survived, col = "blue")
summary(dataset$Survived)
table(dataset$Survived)

# Mostrem l'histograma i un resum de la variable 'Survived'
hist(dataset$Pclass, col = "blue")
summary(dataset$Pclass)
table(dataset$Pclass)

# Mostrem l'histograma i un resum de la variable 'Age'
hist(dataset$Age, col = "blue")
summary(dataset$Age)

# Mostrem l'histograma i un resum de la variable 'SibSp'
hist(dataset$SibSp, col = "blue")
summary(dataset$SibSp)
table(dataset$SibSp)

# Mostrem l'histograma i un resum de la variable 'Parch'
hist(dataset$Parch, col = "blue")
summary(dataset$Parch)
table(dataset$Parch)

# Mostrem l'histograma i un resum de la variable 'Fare'
hist(dataset$Fare, col = "blue")
summary(dataset$Fare)

```

D'aquesta informació, observem el següent:

- **Survived**: Tots els valors són o bé 0 o bé 1. Els valors 99 són els que hem inputat nosaltres quan hem fet el *merge* del joc de dades de 'test' amb el de 'train'. No hi ha cap fora dels valors esperats i, per tant, no eliminarem cap registre en base a aquest atribut.

- **Pclass**: Tots els valors són o bé 1 o bé 2 o bé 3. Les diferents classes de tiquet. No hi ha cap fora dels valors esperats i, per tant, no eliminarem cap registre en base a aquest atribut.

- **Age**: El mínim és 0.17 i el màxim és 80. No hi ha cap edat que cridi l'atenció com per considerar-la fora de l'esperat i eliminar-la del joc de dades.

- **SibSp**: Gran part dels valors són enters entre 0 i 1. Hi ha un 9 observacions amb un valor allunyat de la resta com és el valor 8. Tot i això, és un valor que seria possible ja que existeixen families numerosas amb aquesta quantitat de fills. En el nostre cas, no eliminarem aquestes observacions ja que no les considerem extremes (tot i que sí poc probables).

- **Parch**: Gran part dels valors són enters entre 0 i 1. Hi ha 2 observacions amb un valor allunyat de la resta com és el valor 9. Tot i això, és un valor que seria possible ja que existeixen families numerosas amb aquesta quantitat de fills. En el nostre cas, no eliminarem aquestes observacions ja que no les considerem extremes (tot i que sí poc probables).

- **Fare**: Existeixen 4 observacions amb un valor extremadament allunyat de la resta. Aquest valor és el valor 512.329 que és el màxim de la variable. Com hem pogut observar al resum d'estadístiques, la mitjana dels valors d'aquesta columna és 33.295, és a dir, es troba molt lluny de la tendència de valors (també de la mediana i dels quartils). És per aquest motiu que eliminarem aquesta observació i recalcularem la mitjana per introduïrla en els valors que originalment eren buits (ja que abans ho haviem fet amb una mitjana esbiaixada).

Cal apuntar que tot i que hi hagi d'altres valors de la variable **Fare** que semblin extrems, creiem que es poden arribar a donar i és per aquest motiu que els mantindrem.

### Ajust de la variable 'Fare'

A continuació eliminarem el registre que conté el valor extrem en la variable **Fare** i recalcularem la mitjana per introduïrla en els valors que originalment eren buits (ja que abans ho haviem fet amb una mitjana esbiaixada).

```{r message= FALSE, warning=FALSE}

# Calculem el màxim de la variable 'Fare'
max_fare <- max(dataset$Fare)

# Mostrem les dimensions del 'dataset' abans d'eliminar les observacions
dim(dataset)

# Eliminem els registres on el valor és igual al màxim 
dataset <- dataset[dataset$Fare != max_fare,]

# Mostrem les dimensions del 'dataset' després d'eliminar les observacions
dim(dataset)

# Calculem el màxim de la variable 'Fare'
max(dataset$Fare)

# Calculem la mitjana de la variable 'Fare'
mean_fare <- mean(dataset$Fare)

# Introduïm el nou valor en l'observació que originalment era buida (l'observació 1044)
dataset$Fare[c(1044)] <- mean_fare

```

## Altres accions per a la neteja del joc de dades.

Primerament, observem que la primera variable "PassengerId" no és res més que un identificador, per tant procedim a eliminar-la del conjunt de dades ja que no ens interessa per l'estudi.

```{r message= FALSE, warning=FALSE}

# eliminació de la primera columna PassengerId
dim(unique(dataset$PassengerId))
dataset <- dataset[,-1]

```

Observem que les variables 'Survived' i 'Pclass' són de tipus enter, però la seva funció es indicar una categoria. Per tant, procedim a convertir-les en tipu factor.

```{r message= FALSE, warning=FALSE}

# transformació de les variables 

dataset$Survived <- as.factor(dataset$Survived)
class(dataset$Survived)

dataset$Pclass <- as.factor(dataset$Pclass)
class(dataset$Pclass)

```


# Anàlisi de les dades.

## Selecció de grups a analitzar/comparar.

```{r message= FALSE, warning=FALSE}

# Placeholder

```

## Normalitat i homogeneïtat de la variància.

```{r message= FALSE, warning=FALSE}

# Placeholder

```

## Aplicació de proves estadístiques per a la comparació de grups.

```{r message= FALSE, warning=FALSE}

# Placeholder

```


# Representació de resultats (taules i gràfiques).

```{r message= FALSE, warning=FALSE}

# Placeholder

```


# Conclusions.

 
